# NTEX IoT Server

<p align="center">
  <a href="http://nestjs.com/" target="blank">
    <img src="https://nestjs.com/img/logo-small.svg" width="120" alt="Nest Logo" />
  </a>
</p>

**Server backend cho h·ªá th·ªëng gi√°m s√°t s·ª©c kh·ªèe tr·∫ª em th√¥ng qua IoT Tag & Dock**

## üèóÔ∏è Ki·∫øn tr√∫c h·ªá th·ªëng

```mermaid
flowchart TD
    subgraph Tag["Tag BLE"]
        T1[Sensor: Nhi·ªát ƒë·ªô, Gia t·ªëc]
        T2[Mic + VAD: ph√°t hi·ªán ti·∫øng kh√≥c]
        T3[G·ª≠i d·ªØ li·ªáu qua BLE]
    end

    subgraph Dock["Dock"]
        D1[Nh·∫≠n BLE t·ª´ Tag]
        D2["X·ª≠ l√Ω AI Edge<br/>(ph√¢n lo·∫°i kh√≥c, t∆∞ th·∫ø, s·ªët)"]
        D3[N√©n audio khi c·∫ßn]
        D4[Publish d·ªØ li·ªáu l√™n MQTT]
    end

    subgraph MQTT["MQTT Broker"]
        M1[Nh·∫≠n data t·ª´ Dock]
        M2[Fanout cho subscriber]
    end

    subgraph Server["Server"]
        S1[Subscriber ch√≠nh]
        S2[L∆∞u DB]
        S3[Ph√¢n t√≠ch n√¢ng cao]
        S4[Sinh c·∫£nh b√°o]
        S5["G·ª≠i realtime ‚Üí App<br/>(WebSocket)"]
        S6["G·ª≠i push ‚Üí App<br/>(FCM)"]
    end

    subgraph App["App Mobile"]
        A1["Nh·∫≠n realtime<br/>(WebSocket)"]
        A2["Nh·∫≠n c·∫£nh b√°o<br/>(FCM background)"]
        A3["G·ª≠i feedback ‚Üí Server<br/>(REST/WebSocket)"]
    end

    subgraph Dev["Option Dev/Test"]
        AD["App sub MQTT<br/>(√≠t d√πng production)"]
    end

    Tag --> Dock
    Dock --> MQTT
    MQTT --> Server
    MQTT --> Dev
    Server --> App
    App --> Server
```

## üöÄ Kh·ªüi ch·∫°y d·ª± √°n

### C√†i ƒë·∫∑t dependencies
```bash
yarn install
```

### Thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng
```bash
# Copy file .env.example v√† ƒëi·ªÅu ch·ªânh
cp .env.example .env
```

File .env:
```env
DATABASE_URL="postgres://username:password@host:port/database?sslmode=require"
MQTT_BROKER_URL="mqtt://broker.emqx.io:1883"
```

### Ch·∫°y database migrations
```bash
npx prisma migrate dev
npx prisma generate
```

### Kh·ªüi ch·∫°y server
```bash
# Development mode
yarn start:dev

# Production mode
yarn start:prod
```

Server s·∫Ω ch·∫°y t·∫°i: `http://localhost:3000`

## üì° MQTT Integration

Server l·∫Øng nghe topic: `iot/tag/data`

**Format d·ªØ li·ªáu t·ª´ Dock (Updated):**
```json
{
  "dock_id": "DOCK-001",               // ƒê·ªãnh danh Dock
  "device_id": "TAG-001",              // ƒê·ªãnh danh Tag
  "timestamp": 1724572800,             // Unix epoch
  "temperature": 36.5,                 // ¬∞C
  "acceleration": [0.1, -0.2, 9.8],    // raw sensor data
  "battery": 85,                       // %
  "audio_segment": "BASE64_STRING"     // optional (ch·ªâ khi VAD trigger)
}
```

**Server Workflow:**
1. üì• **MQTT Subscribe** ‚Üí Nh·∫≠n data t·ª´ Dock
2. üìä **Data Processing** ‚Üí Parse, validate, normalize
3. üóÑÔ∏è **Database Storage** ‚Üí L∆∞u v√†o TimescaleDB (Postgres)
4. üîç **Alert Analysis** ‚Üí Ph√¢n t√≠ch business rules
5. üåê **WebSocket Broadcast** ‚Üí Realtime cho app online
6. üì± **FCM Push** ‚Üí Notification cho app offline
7. üìù **Alert Logging** ‚Üí L∆∞u l·ªãch s·ª≠ c·∫£nh b√°o

**G·ª≠i command xu·ªëng Tag/Dock:**
```javascript
// Topic: iot/tag/command/{device_id}
{
  "action": "feedback_received",
  "message": "ƒê√£ nh·∫≠n ph·∫£n h·ªìi t·ª´ ph·ª• huynh",
  "timestamp": 1694876500
}
```

## üåê REST API

### Health Check
```http
GET /api/health
```
**Response:**
```json
{
  "status": "ok",
  "uptime": 3600.123,
  "timestamp": "2025-09-16T12:00:00.000Z",
  "version": "1.0.0",
  "services": {
    "database": "connected",
    "mqtt": "connected"
  }
}
```

### MQTT Health
```http
GET /api/health/mqtt
```

### ƒêƒÉng k√Ω Device & FCM Token (New)
```http
POST /api/device/register
Content-Type: application/json

{
  "user_id": "user123",
  "device_id": "TAG-001", 
  "dock_id": "DOCK-001",
  "fcm_token": "fcm_token_here",
  "device_name": "Tag c·ªßa b√© An"
}
```

### C·∫≠p nh·∫≠t FCM Token (New)
```http
PUT /api/device/fcm-token
Content-Type: application/json

{
  "user_id": "user123",
  "device_id": "TAG-001",
  "fcm_token": "new_fcm_token"
}
```

### L·∫•y danh s√°ch Alerts (New)
```http
GET /api/device/TAG-001/alerts?limit=50
```
**Response:**
```json
[
  {
    "id": 1,
    "device_id": "TAG-001",
    "alert_type": "high_temp",
    "message": "B√© TAG-001 s·ªët cao 38.5¬∞C",
    "is_sent": true,
    "is_read": false,
    "timestamp": "2025-09-16T12:00:00.000Z"
  }
]
```

### ƒê√°nh d·∫•u Alert ƒë√£ ƒë·ªçc (New)
```http
PUT /api/alert/1/read
```

### G·ª≠i Feedback
```http
POST /api/feedback
Content-Type: application/json

{
  "device_id": "TAG_001",
  "feedback": "B√© ƒë√£ ng·ªß ngon"
}
```

### L·∫•y d·ªØ li·ªáu thi·∫øt b·ªã
```http
GET /api/device/TAG_001/data?limit=50
```
**Response:**
```json
[
  {
    "id": 1,
    "dock_id": "DOCK-001",
    "device_id": "TAG_001",
    "temperature": 37.5,
    "acceleration": [0.1, -0.2, 9.8],
    "battery": 85,
    "audio_segment": null,
    "timestamp": "2025-09-16T12:00:00.000Z"
  }
]
```

### L·∫•y d·ªØ li·ªáu theo kho·∫£ng th·ªùi gian
```http
GET /api/device/TAG_001/data/range?start=2025-09-16T00:00:00.000Z&end=2025-09-16T23:59:59.999Z
```

## üîå WebSocket (Real-time)

K·∫øt n·ªëi: `ws://localhost:3000`

**Event nh·∫≠n ƒë∆∞·ª£c:**
```javascript
// Khi c√≥ d·ªØ li·ªáu m·ªõi t·ª´ Tag
socket.on('newData', (data) => {
  console.log('D·ªØ li·ªáu m·ªõi:', data);
  // data = { ...deviceData, alert: "Nguy c∆° s·ªët cao" }
});
```

**Example client code (JavaScript):**
```javascript
import { io } from 'socket.io-client';

const socket = io('http://localhost:3000');

socket.on('connect', () => {
  console.log('‚úÖ Connected to WebSocket');
});

socket.on('newData', (data) => {
  console.log('üì° New device data:', data);
  
  if (data.alert) {
    // Hi·ªÉn th·ªã c·∫£nh b√°o trong app
    showAlert(data.alert, data);
  }
});

socket.on('disconnect', () => {
  console.log('üì¥ Disconnected from WebSocket');
});
```

## üì± Push Notifications (FCM) - Enhanced

**Alert Types & Triggers:**
- `high_temp`: Nhi·ªát ƒë·ªô > 38.0¬∞C ‚Üí "B√© TAG-001 s·ªët cao 38.5¬∞C"
- `low_battery`: Pin < 20% ‚Üí "Pin Tag TAG-001 y·∫øu (15%)"
- `crying_detected`: Audio segment detected ‚Üí "Ph√°t hi·ªán ti·∫øng kh√≥c t·ª´ TAG-001"
- `high_movement`: Acceleration > 15g ‚Üí "Chuy·ªÉn ƒë·ªông b·∫•t th∆∞·ªùng t·ª´ TAG-001"

**FCM Token Management:**
- üìù App ƒëƒÉng k√Ω FCM token qua API `/device/register`
- üîÑ Auto cleanup invalid tokens
- üë• Multi-user support (1 device c√≥ th·ªÉ c√≥ nhi·ªÅu FCM tokens)
- üìä Track notification delivery status

**FCM Payload Format:**
```json
{
  "notification": {
    "title": "C·∫£nh b√°o s·ª©c kh·ªèe",
    "body": "B√© TAG-001: Nguy c∆° s·ªët cao. Nhi·ªát ƒë·ªô: 38.5¬∞C"
  },
  "data": {
    "device_id": "TAG-001",
    "alert_type": "high_temp", 
    "alert_id": "123",
    "temperature": "38.5"
  }
}
```

## üìä Database Schema (Prisma) - Updated

```prisma
model DeviceData {
  id             Int      @default(autoincrement())
  dock_id        String   // ƒê·ªãnh danh Dock
  device_id      String   // ƒê·ªãnh danh Tag  
  temperature    Float
  acceleration   Float[]
  battery        Int
  audio_segment  String?  // Base64 compressed audio
  timestamp      DateTime @default(now())
  
  @@id([id, timestamp])
  @@index([device_id, timestamp])
  @@index([dock_id, timestamp])
  @@map("DeviceData")
}

model UserDevice {
  id          Int      @id @default(autoincrement())
  user_id     String   // ID ph·ª• huynh
  device_id   String   // ID c·ªßa Tag
  dock_id     String?  // ID c·ªßa Dock (optional)
  fcm_token   String?  // FCM token
  device_name String?  // T√™n thi·∫øt b·ªã
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  @@unique([user_id, device_id])
  @@map("UserDevice")
}

model Alert {
  id         Int      @id @default(autoincrement())
  device_id  String
  alert_type String   // high_temp, low_battery, crying_detected, high_movement
  message    String
  is_sent    Boolean  @default(false)  // ƒê√£ g·ª≠i FCM ch∆∞a
  is_read    Boolean  @default(false)  // User ƒë√£ xem ch∆∞a
  timestamp  DateTime @default(now())
  
  @@index([device_id, timestamp])
  @@map("Alert")
}

model Feedback {
  id        Int      @id @default(autoincrement())
  device_id String
  feedback  String
  timestamp DateTime @default(now())

  @@map("Feedback")
}
```

**Database Features:**
- üïê **TimescaleDB**: T·ªëi ∆∞u time-series data cho IoT
- üìà **Hypertables**: Auto partitioning theo timestamp
- üîç **Indexing**: Optimized queries cho device_id + timestamp
- üóÇÔ∏è **Multi-tenant**: Support nhi·ªÅu user/device

## üîÑ Server Workflow Chi Ti·∫øt

### 1. Kh·ªüi ƒë·ªông Server
```mermaid
graph TD
    A[Server Start] --> B[Init Database Connection]
    B --> C[Init Firebase Admin SDK]
    C --> D[Connect MQTT Broker]
    D --> E[Subscribe iot/tag/data]
    E --> F[Start WebSocket Server]
    F --> G[Start REST API]
    G --> H[‚úÖ Server Ready]
```

### 2. Data Processing Pipeline
```mermaid
sequenceDiagram
    participant D as Dock
    participant M as MQTT Broker
    participant S as Server
    participant DB as Database
    participant WS as WebSocket
    participant FCM as Firebase

    D->>M: Publish iot/tag/data
    M->>S: Forward message
    S->>S: Parse & Validate JSON
    S->>DB: Save DeviceData
    S->>S: Analyze Rules (temp, battery, audio)
    
    alt Alert Generated
        S->>DB: Save Alert record
        S->>FCM: Send Push Notification
        S->>WS: Broadcast with alert
    else No Alert
        S->>WS: Broadcast normal data
    end
```

### 3. Real-time Communication Flow
```mermaid
graph LR
    subgraph "App States"
        A1[App Online]
        A2[App Background]
        A3[App Closed]
    end
    
    subgraph "Server Response"
        S1[WebSocket Broadcast]
        S2[FCM Push Only]
        S3[FCM Push + Store Alert]
    end
    
    A1 --> S1
    A2 --> S2
    A3 --> S3
```

### 4. Error Handling & Resilience
- **MQTT Reconnection**: Exponential backoff, max 5 attempts
- **Database Retry**: Auto-retry v·ªõi Prisma connection pool
- **FCM Token Cleanup**: Auto-remove invalid tokens
- **WebSocket Recovery**: Client auto-reconnect
- **Data Validation**: Strict schema validation tr∆∞·ªõc khi l∆∞u DB

## üîß Configuration & Environment

### Required Environment Variables
```env
# Database (TimescaleDB/PostgreSQL)
DATABASE_URL="postgres://user:pass@host:port/db?sslmode=require"

# MQTT Broker
MQTT_BROKER_URL="mqtt://broker.emqx.io:1883"
MQTT_USERNAME=""  # optional
MQTT_PASSWORD=""  # optional

# Server
PORT=3000
NODE_ENV=production

# Firebase (cho FCM)
# C·∫ßn file token/serviceAccountKey.json
```

### Firebase Setup
1. T·∫°o Firebase project t·∫°i https://console.firebase.google.com
2. Generate Service Account Key
3. Download file JSON v√† ƒë·∫∑t t·∫°i `token/serviceAccountKey.json`
4. Enable Cloud Messaging API

### MQTT Broker Options
```bash
# Public brokers (development)
mqtt://broker.emqx.io:1883
mqtt://test.mosquitto.org:1883  
mqtt://mqtt.eclipseprojects.io:1883

# Self-hosted (production)
docker run -d -p 1883:1883 eclipse-mosquitto
```

## üß™ Testing - Comprehensive

### Test MQTT v·ªõi CLI
```bash
# C√†i MQTT CLI
npm install -g mqtt

# Subscribe ƒë·ªÉ xem data
mqtt sub -h broker.emqx.io -p 1883 -t "iot/tag/data"

# Publish test data v·ªõi format m·ªõi
mqtt pub -h broker.emqx.io -p 1883 -t "iot/tag/data" -m '{
  "dock_id": "DOCK-001",
  "device_id": "TAG-001",
  "timestamp": 1724572800,
  "temperature": 38.5,
  "acceleration": [0.1, -0.2, 9.8],
  "battery": 15,
  "audio_segment": null
}'

# Test v·ªõi audio alert
mqtt pub -h broker.emqx.io -p 1883 -t "iot/tag/data" -m '{
  "dock_id": "DOCK-001", 
  "device_id": "TAG-001",
  "timestamp": 1724572900,
  "temperature": 37.0,
  "acceleration": [0.0, 0.0, 9.8],
  "battery": 80,
  "audio_segment": "SGVsbG8gV29ybGQ="
}'
```

### Test REST API v·ªõi curl
```bash
# Health checks
curl http://localhost:3000/api/health
curl http://localhost:3000/api/health/mqtt

# Register device & FCM token
curl -X POST http://localhost:3000/api/device/register \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user123",
    "device_id": "TAG-001",
    "dock_id": "DOCK-001", 
    "fcm_token": "test_fcm_token",
    "device_name": "Tag c·ªßa b√© An"
  }'

# Update FCM token
curl -X PUT http://localhost:3000/api/device/fcm-token \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user123",
    "device_id": "TAG-001",
    "fcm_token": "new_fcm_token"
  }'

# Get device data
curl "http://localhost:3000/api/device/TAG-001/data?limit=10"

# Get alerts
curl "http://localhost:3000/api/device/TAG-001/alerts?limit=10"

# Mark alert as read
curl -X PUT http://localhost:3000/api/alert/1/read

# Send feedback
curl -X POST http://localhost:3000/api/feedback \
  -H "Content-Type: application/json" \
  -d '{"device_id": "TAG-001", "feedback": "Test feedback"}'
```

### Test WebSocket v·ªõi Node.js
```javascript
const io = require('socket.io-client');
const socket = io('http://localhost:3000');

socket.on('connect', () => {
  console.log('‚úÖ Connected to WebSocket');
});

socket.on('newData', (data) => {
  console.log('üì° Received data:', data);
  if (data.alert) {
    console.log('üö® Alert:', data.alert);
  }
});

socket.on('disconnect', () => {
  console.log('üì¥ Disconnected');
});
```

### End-to-End Test Scenario
1. **Start Server**: `yarn start:dev`
2. **Connect WebSocket**: Ch·∫°y test client
3. **Publish MQTT**: G·ª≠i test data v·ªõi temperature > 38¬∞C
4. **Verify Pipeline**:
   - ‚úÖ Data saved in database
   - ‚úÖ Alert generated
   - ‚úÖ WebSocket broadcast received
   - ‚úÖ FCM notification attempted
   - ‚úÖ Alert logged in database

## üê≥ Docker Development

```bash
# Start MQTT broker
docker run -d --name mosquitto -p 1883:1883 eclipse-mosquitto

# Start PostgreSQL
docker run -d --name postgres \
  -e POSTGRES_PASSWORD=password \
  -e POSTGRES_DB=ntex \
  -p 5432:5432 postgres:15
```

## üìÇ C·∫•u tr√∫c d·ª± √°n

```
src/
‚îú‚îÄ‚îÄ api/                 # REST API module
‚îÇ   ‚îú‚îÄ‚îÄ api.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ api.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ api.module.ts
‚îú‚îÄ‚îÄ database/            # Database & Prisma
‚îÇ   ‚îú‚îÄ‚îÄ prisma.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ database.module.ts
‚îú‚îÄ‚îÄ mqtt/                # MQTT client
‚îÇ   ‚îú‚îÄ‚îÄ mqtt.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ mqtt.module.ts
‚îú‚îÄ‚îÄ push/                # FCM push notifications
‚îÇ   ‚îú‚îÄ‚îÄ push.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ push.module.ts
‚îú‚îÄ‚îÄ websocket/           # WebSocket gateway
‚îÇ   ‚îú‚îÄ‚îÄ app.gateway.ts
‚îÇ   ‚îî‚îÄ‚îÄ websocket.module.ts
‚îú‚îÄ‚îÄ app.controller.ts
‚îú‚îÄ‚îÄ app.service.ts
‚îú‚îÄ‚îÄ app.module.ts
‚îî‚îÄ‚îÄ main.ts
```

## üîß Scripts - Complete List

```bash
# Development
yarn start:dev          # Ch·∫°y v·ªõi hot reload + file watching
yarn start:debug        # Ch·∫°y debug mode (port 9229)
yarn start              # Ch·∫°y production build locally

# Production 
yarn build              # Build TypeScript ‚Üí JavaScript
yarn start:prod         # Ch·∫°y production (c·∫ßn build tr∆∞·ªõc)

# Database & Prisma
yarn prisma:generate    # Generate Prisma client
yarn prisma:migrate     # T·∫°o migration m·ªõi
yarn prisma:deploy      # Apply migrations (production)
yarn prisma:studio      # M·ªü Prisma Studio GUI
yarn prisma:reset       # Reset database (development only)
yarn prisma:seed        # Ch·∫°y database seeding

# Testing
yarn test               # Unit tests v·ªõi Jest
yarn test:watch         # Jest watch mode
yarn test:e2e           # End-to-end tests
yarn test:cov           # Test coverage report
yarn test:debug         # Debug tests

# Code Quality
yarn lint               # ESLint check
yarn lint:fix           # Auto-fix ESLint issues
yarn format             # Prettier format
yarn type-check         # TypeScript type checking

# Docker
yarn docker:build       # Build Docker image
yarn docker:run         # Run container locally
yarn docker:compose     # Start v·ªõi docker-compose
```

## üì¶ Dependencies Summary

### Core Dependencies
- **NestJS**: Framework backend
- **Prisma**: ORM & database toolkit
- **MQTT.js**: MQTT client
- **Socket.io**: WebSocket server
- **Firebase Admin**: FCM push notifications

### Database
- **PostgreSQL**: Primary database
- **TimescaleDB**: Time-series extension

### Development Tools
- **TypeScript**: Type safety
- **Jest**: Testing framework
- **ESLint + Prettier**: Code quality
- **Nodemon**: Hot reload

## üêõ Troubleshooting

## üêõ Troubleshooting - Extended

### MQTT Connection Issues
```bash
# Test broker connectivity
telnet broker.emqx.io 1883

# Check if port is open
nmap -p 1883 broker.emqx.io

# Test with different brokers
mqtt sub -h test.mosquitto.org -p 1883 -t "test/topic"
mqtt sub -h mqtt.eclipseprojects.io -p 1883 -t "test/topic"
```

### Database Issues
```bash
# Test TimescaleDB connection
psql "postgresql://username:password@host:port/database"

# Check TimescaleDB extension
psql -c "SELECT * FROM timescaledb_information.hypertables;"

# Verify migrations
npx prisma migrate status

# Reset database if needed
npx prisma migrate reset --force
```

### Firebase/FCM Issues
```bash
# Verify service account key
node -e "console.log(require('./token/serviceAccountKey.json').project_id)"

# Test Firebase connection
curl -X POST https://fcm.googleapis.com/v1/projects/YOUR_PROJECT_ID/messages:send \
  -H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
  -H "Content-Type: application/json" \
  -d '{"message":{"token":"test","notification":{"title":"Test"}}}'
```

### Common Error Codes & Solutions

| Error | Cause | Solution |
|-------|-------|----------|
| `ECONNRESET` | MQTT broker unavailable | Try different broker or check network |
| `P1001` | Database timeout | Check connection string & network |
| `messaging/registration-token-not-registered` | Invalid FCM token | Token auto-cleanup implemented |
| `ValidationError` | Invalid data format | Check MQTT payload schema |
| `TimescaleDB not found` | Extension not enabled | Run `CREATE EXTENSION timescaledb;` |

### Performance Monitoring
```sql
-- Check database performance
SELECT COUNT(*) FROM "DeviceData" WHERE timestamp > NOW() - INTERVAL '1 hour';

-- Monitor hypertable chunks
SELECT chunk_name, range_start, range_end 
FROM timescaledb_information.chunks 
WHERE hypertable_name = 'DeviceData' 
ORDER BY range_start DESC LIMIT 10;

-- Alert statistics
SELECT alert_type, COUNT(*), AVG(CASE WHEN is_sent THEN 1 ELSE 0 END) as success_rate
FROM "Alert" 
WHERE timestamp > NOW() - INTERVAL '24 hours'
GROUP BY alert_type;
```

## üìù Logs - Enhanced Format

**Server Startup:**
```
üîÑ Starting NTEX IoT Server...
‚úÖ Database connected (TimescaleDB)
‚úÖ Firebase Admin SDK initialized  
üîÑ Attempting to connect to MQTT broker: mqtt://broker.emqx.io:1883
‚úÖ Connected to MQTT broker
üì• Subscribed to iot/tag/data
üåê WebSocket server started on port 3000
üì° REST API server started on port 3000
üöÄ Server ready - All systems operational
```

**Data Processing:**
```
üì° Received on iot/tag/data: {"dock_id":"DOCK-001","device_id":"TAG-001",...}
üìä Processing data for device TAG-001 from dock DOCK-001
üíæ Data saved to database (ID: 1234)
üîç Alert analysis: temperature=38.5¬∞C ‚Üí high_temp alert generated
üìù Alert saved (ID: 567): "B√© TAG-001 s·ªët cao 38.5¬∞C"
üì± FCM notification sent to 2 users
üåê WebSocket broadcast: {"device_id":"TAG-001","alert":"high_temp",...}
‚úÖ Processing completed in 45ms
```

**Error Handling:**
```
‚ùå MQTT connection error: ECONNRESET
üîÑ Reconnection attempt 1/5 in 1000ms
‚ö†Ô∏è No FCM tokens found for device TAG-002
‚ùå FCM send error for token abc123: messaging/registration-token-not-registered
üßπ Cleaned up invalid FCM token for user456
```

**Health Monitoring:**
```
üìä Health Check - All systems: OK
  ‚îú‚îÄ Database: ‚úÖ Connected (TimescaleDB)
  ‚îú‚îÄ MQTT: ‚úÖ Connected (broker.emqx.io)
  ‚îú‚îÄ Firebase: ‚úÖ Initialized
  ‚îú‚îÄ WebSocket: ‚úÖ 3 clients connected
  ‚îî‚îÄ Uptime: 3h 45m 12s
```

## ü§ù Contributing

1. Fork project
2. T·∫°o feature branch: `git checkout -b feature/new-feature`
3. Commit changes: `git commit -am 'Add new feature'`
4. Push branch: `git push origin feature/new-feature`
5. T·∫°o Pull Request

## üìÑ License

MIT Licensed. Xem file LICENSE ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.

## üë• Authors

- **NT Team** - *Initial work*

## üîó Links

- [NestJS Documentation](https://docs.nestjs.com)
- [Prisma Documentation](https://www.prisma.io/docs)
- [MQTT.js Documentation](https://github.com/mqttjs/MQTT.js)
- [Socket.io Documentation](https://socket.io/docs/v4/)